# MF_ETL API Documentation

## Overview

The MF_ETL API is a FastAPI-based service for enriching mutual fund data from multiple sources (AMFI/mftool, Morningstar/mstarpy, NSE/jugaad).

## Base URL

```
http://localhost:8000
```

## Endpoints

### POST /etl/enrich

Enrich mutual fund holdings with additional data from AMFI and Morningstar.

#### Request

```json
{
  "upload_id": "test-upload-001",
  "parsed_holdings": [
    {
      "fund_name": "Motilal Oswal Midcap Direct Growth",
      "holding_id": "MO-MID-001",
      "quantity": 100
    }
  ]
}
```

#### Request Parameters

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `upload_id` | string | Yes | Unique identifier for this enrichment request |
| `parsed_holdings` | array | Yes | Array of holdings to enrich |
| `parsed_holdings[].fund_name` | string | Yes | Name of the mutual fund |
| `parsed_holdings[].holding_id` | string | No | Unique identifier for the holding |
| `parsed_holdings[].quantity` | number | No | Quantity of units held |

#### Response (Success - 200)

```json
{
  "upload_id": "test-upload-001",
  "status": "completed",
  "duration_seconds": 45,
  "enriched_funds": [
    {
      "fund_name": "Motilal Oswal Midcap Direct Growth",
      "isin": "INF949K01YY2",
      "amc": "Motilal Oswal Mutual Fund",
      "category": "Equity - Midcap",
      "expense_ratio": 0.47,
      "current_nav": 49.9240,
      "nav_as_of": "11-Dec-2025",
      "top_holdings": [
        {
          "securityName": "Company Ltd",
          "weighting": 5.99,
          "sector": "Industrials"
        }
      ],
      "sector_allocation": {
        "industrials": 29.10,
        "financialServices": 26.10,
        "consumerCyclical": 21.57
      }
    }
  ],
  "enrichment_quality": {
    "successfully_enriched": 1,
    "failed_to_enrich": 0,
    "warnings": []
  },
  "error_message": null
}
```

#### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `upload_id` | string | Echo of the request upload_id |
| `status` | string | "completed", "failed", or "timeout" |
| `duration_seconds` | integer | Total processing time |
| `enriched_funds` | array | Array of enriched fund data |
| `enrichment_quality` | object | Quality metrics for enrichment |
| `error_message` | string | Error message if status is "failed" |

#### Response (Error - 400/422)

```json
{
  "upload_id": "test-upload-001",
  "status": "failed",
  "duration_seconds": null,
  "enriched_funds": [],
  "enrichment_quality": {
    "successfully_enriched": 0,
    "failed_to_enrich": 0,
    "warnings": ["Error message describing what went wrong"]
  },
  "error_message": "Detailed error message"
}
```

## Fund Resolution Strategy

The API uses an intelligent fallback strategy for matching funds in Morningstar:

### Primary Search Terms (Official AMFI Names)
1. Official AMFI scheme name from mftool database
2. Alternate scheme names generated by the resolver

### Fallback Search Terms (If Primary Fails)
1. User-provided fund name
2. Official name with plan type suffixes removed
   - Example: "Motilal Oswal Midcap Fund-Direct - IDCW Payout/Reinvestment" → "Motilal Oswal Midcap Fund"
3. Name with parenthetical content removed
4. Core fund name (first 3 words)
   - Example: "Motilal Oswal Midcap"
5. AMC + Category name

## Examples

### Example 1: Basic Enrichment Request

```bash
curl -X POST "http://localhost:8000/etl/enrich" \
  -H "Content-Type: application/json" \
  -d '{
    "upload_id": "daily-batch-001",
    "parsed_holdings": [
      {
        "fund_name": "Motilal Oswal Midcap Direct Growth",
        "holding_id": "MO-001"
      }
    ]
  }'
```

### Example 2: Multiple Holdings

```bash
curl -X POST "http://localhost:8000/etl/enrich" \
  -H "Content-Type: application/json" \
  -d '{
    "upload_id": "batch-002",
    "parsed_holdings": [
      {
        "fund_name": "Motilal Oswal Midcap Direct Growth",
        "holding_id": "MO-001",
        "quantity": 100
      },
      {
        "fund_name": "HDFC Equity Fund",
        "holding_id": "HDFC-001",
        "quantity": 50
      }
    ]
  }'
```

## Error Handling

### Validation Errors (422)

Returned when request structure is invalid:
- Missing required fields
- Invalid data types
- Malformed JSON

### Processing Errors (400)

Returned when data validation fails:
- No valid holdings provided
- All holdings failed validation

### Timeout Errors (504)

Returned when processing exceeds 120 seconds (configurable via `ENRICHMENT_TIMEOUT_SECONDS`)

## Logging

All API calls are logged with detailed information:

```
================================================================================
ENRICHMENT RESPONSE
================================================================================
Upload ID: test-upload-001
Status: completed
Duration: 45s
Successfully enriched: 1
Failed to enrich: 0

Enriched 1 funds:
  [1] Motilal Oswal Midcap Direct Growth
      ISIN: INF949K01YY2
      AMC: Motilal Oswal Mutual Fund
      Category: Equity - Midcap
      Current NAV: 49.9240
      NAV As Of: 11-Dec-2025
      Expense Ratio: 0.47%
      Top Holdings: 38 holdings
      Sectors: 11 sectors
================================================================================
```

## Rate Limiting

Currently, there is no rate limiting. Each request is processed sequentially with a maximum timeout of 120 seconds.

## CORS

The API is configured to accept requests from:
- `http://localhost:8080`
- `http://localhost:3000`

Update in `services/api/main.py` to add more origins.

## Health Check

```bash
curl http://localhost:8000/docs  # Interactive API documentation (Swagger UI)
curl http://localhost:8000/redoc # Alternative API documentation (ReDoc)
```

## Performance Considerations

1. **ISIN Lookup**: First tries mftool, then mstarpy direct lookup
2. **Search Strategy**: Primary AMFI name → Fallback variations
3. **Caching**: Future implementation for faster repeated lookups
4. **Async Processing**: Requests are processed asynchronously
5. **Timeout**: 120 seconds default (configurable)

## Troubleshooting

### Common Issues

1. **Fund not found in Morningstar**
   - Check logs to see which search terms were tried
   - The API falls back through multiple variations
   - Some funds may not have Morningstar data available

2. **Validation failures**
   - Ensure fund_name is provided and non-empty
   - Check that holdings payload matches the schema

3. **Timeout errors**
   - Increase `ENRICHMENT_TIMEOUT_SECONDS` in `.env`
   - Process fewer holdings per request
   - Check network connectivity to data sources
